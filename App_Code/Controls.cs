using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Collections;
using System.Configuration;
using System.Data.SqlClient;


/// <summary>
/// Summary description for Controls
/// </summary>
public static class Controls
{


    private static SqlConnection conn;
    private static SqlCommand command;

    static Controls()
    {
        // đường dẩn nằm trong webconfig ,nhằm đóng gói sản phẩm khi thay đổi csdl 
        string connectionString = ConfigurationManager.ConnectionStrings["DatabaseConnectionString"].ToString();
        conn = new SqlConnection(connectionString);
        command = new SqlCommand("", conn);
    }



 public static void addInboxSMs(Message msg)
    {
        string query = string.Format(

    @"INSERT INTO  tblMSG ( [type],[object],[content],[date] )
                                VALUES ('{0}', '{1}', '{2}','{3}')",
                            1, msg.Object,msg.Content,msg.date);
        command.CommandText = query; ;

        try
        {
            conn.Open();
            command.ExecuteNonQuery();
        }
        finally
        {
            conn.Close();
            //  command.Parameters.Clear();
        }


    }
    public static void addSentboxSMs(Message msg)
    {
        string query = string.Format(

    @"INSERT INTO  tblMSG ( [type],[object],[content],[date] )
                                VALUES ('{0}', '{1}', '{2}','{3}')",
                       0, msg.Object, msg.Content, msg.date);
        command.CommandText = query; ;

        try
        {
            conn.Open();
            command.ExecuteNonQuery();
        }
        finally
        {
            conn.Close();
            //  command.Parameters.Clear();
        }



    }


    public static void checkMSG(Message msg)
    {
        string query = string.Format("SELECT COUNT(*) FROM tblMSG WHERE type = '{0}' and object = '{1}' and content = '{2}' and date = '{3}' ", msg._type,msg.Object,msg.Content,msg.date);
        command.CommandText = query;

        try
        {
            conn.Open();
            int amountOfMSG = (int)command.ExecuteScalar();

            if (amountOfMSG < 1)
            {
                if (msg._type == 1)
                {
                    addInboxSMs(msg);
                }
                else
                { addSentboxSMs(msg); }
            
            }
            else
            {
                //User exists
                return;
            }
        }
        finally
        {
            conn.Close();
        }

    }

    public static string RegisterUser(Users user)
    {
        //Check if user exists
        string query = string.Format("SELECT COUNT(*) FROM Users WHERE name = '{0}'", user.UserName);
        command.CommandText = query;

        try
        {
            conn.Open();
            int amountOfUsers = (int)command.ExecuteScalar();

            if (amountOfUsers < 1)
            {
                //User does not exist, create a new user
                query = string.Format("INSERT INTO Users ( [Name], [Pass] , [Mail] , [Phone]) VALUES (N'{0}', N'{1}', N'{2}', N'{3}')",
                    user.UserName, user.Password,   user.Email, user.Phone);
                command.CommandText = query;
                command.ExecuteNonQuery();
                return " registered Sucessfully!";
            }
            else
            {
                //User exists
                return "Oops! , A user with this name already exists";
            }
        }
        finally
        {
            conn.Close();
        }
    }
    // Đăng nhập, xác thực  User 
    // Cần cập nhật , tìm kiểm các Teamplate về Login vì đây là thành phần đặc biệt quan trọng 
    // Nhưng bạn Tự viết được thì quá giỏi =)) 
    public static Users LoginUser(string name, string password)
    {
        //Check if user exists
        string query = string.Format("SELECT COUNT(*) FROM Users WHERE Name = '{0}'", name);
        command.CommandText = query;

        try
        {
            conn.Open();
            int amountOfUsers = (int)command.ExecuteScalar();

            if (amountOfUsers == 1)
            {
                //User exists, check if the passwords match
                query = string.Format("SELECT Pass FROM Users WHERE Name = '{0}'", name);
                command.CommandText = query;
                string dbPassword = command.ExecuteScalar().ToString();

                if (dbPassword == password)
                {
                    //Passwords match. Login and password data are known to us.
                    //Retrieve further user data from the database
                    query = string.Format("SELECT Mail, Type FROM Users WHERE Name = '{0}'", name);
                    command.CommandText = query;

                    SqlDataReader reader = command.ExecuteReader();
                    Users user = null;

                    while (reader.Read())
                    {
                        string email = reader.GetString(0);
                        int type =Convert.ToInt32( reader.GetString(1));

                        user = new Users(name, password, email, (type));
                    }
                    return user;
                }
                else
                {
                    //Passwords do not match
                    return null;
                }
            }
            else
            {
                //User does not exist
                return null;
            }
        }
        finally
        {

            conn.Close();
        }
    }


}